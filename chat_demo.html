<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Baton AI Agent Demo - Live Feature Flags</title>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@400;600;700&display=swap');

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			:root {
				--primary: #ff6b35;
				--secondary: #004e89;
				--success: #06d6a0;
				--bg-dark: #0a0e27;
				--bg-card: #151a35;
				--text-primary: #ffffff;
				--text-secondary: #8b93b0;
				--border: #2a3351;
				--accent-glow: rgba(255, 107, 53, 0.3);
			}

			body {
				font-family: 'Syne', sans-serif;
				background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1333 100%);
				color: var(--text-primary);
				min-height: 100vh;
				overflow-x: hidden;
			}

			body::before {
				content: '';
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: radial-gradient(
						circle at 20% 80%,
						rgba(255, 107, 53, 0.1) 0%,
						transparent 50%
					),
					radial-gradient(
						circle at 80% 20%,
						rgba(0, 78, 137, 0.1) 0%,
						transparent 50%
					);
				pointer-events: none;
				z-index: 0;
			}

			.container {
				position: relative;
				max-width: 1600px;
				margin: 0 auto;
				padding: 2rem;
				display: grid;
				grid-template-columns: 350px 1fr;
				gap: 2rem;
				min-height: 100vh;
				z-index: 1;
			}

			.header {
				grid-column: 1 / -1;
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 2rem;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
			}

			.header h1 {
				font-size: 2.5rem;
				font-weight: 700;
				background: linear-gradient(
					135deg,
					var(--primary) 0%,
					var(--success) 100%
				);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				margin-bottom: 0.5rem;
			}

			.header p {
				color: var(--text-secondary);
				font-size: 1.1rem;
			}

			.connection-status {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				margin-top: 0.5rem;
				padding: 0.5rem 1rem;
				background: var(--bg-dark);
				border-radius: 8px;
				font-size: 0.9rem;
				font-family: 'JetBrains Mono', monospace;
			}

			.status-dot {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				background: var(--text-secondary);
			}

			.status-dot.connected {
				background: var(--success);
				animation: pulse 2s infinite;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			.flags-panel {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 1.5rem;
				height: fit-content;
				position: sticky;
				top: 2rem;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
			}

			.flags-panel h2 {
				font-size: 1.3rem;
				margin-bottom: 1rem;
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}

			.flag-emoji {
				font-size: 1.5rem;
			}

			.flag-group {
				margin-bottom: 1.5rem;
			}

			.flag-group h3 {
				font-size: 0.85rem;
				text-transform: uppercase;
				letter-spacing: 0.1em;
				color: var(--text-secondary);
				margin-bottom: 0.75rem;
				font-weight: 600;
			}

			.flag-item {
				background: var(--bg-dark);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 1rem;
				margin-bottom: 0.75rem;
				transition: all 0.3s ease;
			}

			.flag-item:hover {
				border-color: var(--primary);
				box-shadow: 0 4px 16px var(--accent-glow);
			}

			.flag-item.active {
				border-color: var(--success);
				background: rgba(6, 214, 160, 0.05);
			}

			.flag-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 0.5rem;
			}

			.flag-name {
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.9rem;
				font-weight: 700;
			}

			.flag-toggle {
				position: relative;
				width: 48px;
				height: 24px;
				background: var(--border);
				border-radius: 12px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.flag-toggle::after {
				content: '';
				position: absolute;
				top: 2px;
				left: 2px;
				width: 20px;
				height: 20px;
				background: white;
				border-radius: 50%;
				transition: all 0.3s ease;
			}

			.flag-toggle.active {
				background: var(--success);
			}

			.flag-toggle.active::after {
				left: 26px;
			}

			.flag-desc {
				font-size: 0.75rem;
				color: var(--text-secondary);
				line-height: 1.4;
			}

			.chat-panel {
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 1.5rem;
				display: flex;
				flex-direction: column;
				height: calc(100vh - 250px);
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
			}

			.chat-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1rem;
				padding-bottom: 1rem;
				border-bottom: 1px solid var(--border);
			}

			.user-id {
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.85rem;
				color: var(--text-secondary);
			}

			.user-id span {
				color: var(--primary);
				font-weight: 700;
			}

			.new-user-btn {
				background: var(--primary);
				color: white;
				border: none;
				padding: 0.5rem 1rem;
				border-radius: 8px;
				font-family: 'Syne', sans-serif;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.new-user-btn:hover {
				background: #ff8555;
				box-shadow: 0 4px 16px var(--accent-glow);
			}

			.messages {
				flex: 1;
				overflow-y: auto;
				padding: 1rem 0;
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}

			.message {
				display: flex;
				gap: 1rem;
				animation: slideIn 0.3s ease;
			}

			@keyframes slideIn {
				from {
					opacity: 0;
					transform: translateY(10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.message-avatar {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1.2rem;
				flex-shrink: 0;
			}

			.user .message-avatar {
				background: linear-gradient(135deg, var(--primary), #ff8555);
			}

			.agent .message-avatar {
				background: linear-gradient(135deg, var(--secondary), var(--success));
			}

			.message-content {
				flex: 1;
				background: var(--bg-dark);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 1rem;
			}

			.message-meta {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 0.5rem;
			}

			.message-role {
				font-weight: 700;
				font-size: 0.9rem;
			}

			.user .message-role {
				color: var(--primary);
			}

			.agent .message-role {
				color: var(--success);
			}

			.agent-name {
				font-size: 0.75rem;
				color: var(--text-secondary);
				font-family: 'JetBrains Mono', monospace;
			}

			.message-text {
				line-height: 1.6;
				color: var(--text-primary);
				white-space: pre-wrap;
			}

			.flag-badge {
				display: inline-block;
				background: rgba(255, 107, 53, 0.2);
				border: 1px solid var(--primary);
				color: var(--primary);
				padding: 0.15rem 0.5rem;
				border-radius: 4px;
				font-size: 0.7rem;
				font-family: 'JetBrains Mono', monospace;
				margin-left: 0.5rem;
			}

			.input-area {
				display: flex;
				gap: 1rem;
				margin-top: 1rem;
				padding-top: 1rem;
				border-top: 1px solid var(--border);
			}

			.input-area input {
				flex: 1;
				background: var(--bg-dark);
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 1rem;
				color: var(--text-primary);
				font-family: 'Syne', sans-serif;
				font-size: 1rem;
				transition: all 0.3s ease;
			}

			.input-area input:focus {
				outline: none;
				border-color: var(--primary);
				box-shadow: 0 0 0 3px var(--accent-glow);
			}

			.input-area button {
				background: linear-gradient(135deg, var(--primary), #ff8555);
				color: white;
				border: none;
				padding: 1rem 2rem;
				border-radius: 12px;
				font-family: 'Syne', sans-serif;
				font-weight: 700;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			.input-area button:hover:not(:disabled) {
				transform: translateY(-2px);
				box-shadow: 0 8px 24px var(--accent-glow);
			}

			.input-area button:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}

			.messages::-webkit-scrollbar {
				width: 8px;
			}

			.messages::-webkit-scrollbar-track {
				background: var(--bg-dark);
				border-radius: 4px;
			}

			.messages::-webkit-scrollbar-thumb {
				background: var(--border);
				border-radius: 4px;
			}

			.loading {
				display: inline-block;
				width: 8px;
				height: 8px;
				border-radius: 50%;
				background: var(--success);
				animation: loadingPulse 1.4s infinite ease-in-out both;
			}

			.loading:nth-child(1) {
				animation-delay: -0.32s;
			}

			.loading:nth-child(2) {
				animation-delay: -0.16s;
			}

			@keyframes loadingPulse {
				0%,
				80%,
				100% {
					opacity: 0.3;
					transform: scale(0.8);
				}
				40% {
					opacity: 1;
					transform: scale(1);
				}
			}

			.thinking {
				display: flex;
				gap: 0.5rem;
				align-items: center;
				color: var(--text-secondary);
				font-size: 0.9rem;
			}

			.config-section {
				background: var(--bg-dark);
				border: 1px solid var(--border);
				border-radius: 8px;
				padding: 1rem;
				margin-bottom: 1rem;
			}

			.config-section label {
				display: block;
				font-size: 0.85rem;
				color: var(--text-secondary);
				margin-bottom: 0.5rem;
				font-family: 'JetBrains Mono', monospace;
			}

			.config-section input {
				width: 100%;
				background: var(--bg-card);
				border: 1px solid var(--border);
				border-radius: 6px;
				padding: 0.5rem;
				color: var(--text-primary);
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.85rem;
			}

			.config-section input:focus {
				outline: none;
				border-color: var(--primary);
			}

			@media (max-width: 1200px) {
				.container {
					grid-template-columns: 1fr;
				}

				.flags-panel {
					position: static;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>üö© Baton AI Agent - Live Demo</h1>
				<p>Real LangGraph agents with production feature flags</p>
				<div class="connection-status">
					<div class="status-dot" id="statusDot"></div>
					<span id="statusText">Connecting to LangGraph...</span>
				</div>
			</div>

			<aside class="flags-panel">
				<h2><span class="flag-emoji">üö©</span> Feature Flags</h2>

				<div class="config-section">
					<label>LangGraph API URL:</label>
					<input
						type="text"
						id="apiUrl"
						value="http://127.0.0.1:2024"
						placeholder="http://127.0.0.1:2024"
					/>
				</div>

				<div class="flag-group">
					<h3>Lead Capture</h3>

					<div class="flag-item" data-flag="aggressive_capture">
						<div class="flag-header">
							<span class="flag-name">aggressive_capture</span>
							<div class="flag-toggle"></div>
						</div>
						<div class="flag-desc">
							Ask for contact info after first listing view
						</div>
					</div>

					<div class="flag-item" data-flag="require_both_contacts">
						<div class="flag-header">
							<span class="flag-name">require_both_contacts</span>
							<div class="flag-toggle"></div>
						</div>
						<div class="flag-desc">Require BOTH email AND phone</div>
					</div>
				</div>

				<div class="flag-group">
					<h3>Information</h3>

					<div class="flag-item active" data-flag="show_risks_upfront">
						<div class="flag-header">
							<span class="flag-name">show_risks_upfront</span>
							<div class="flag-toggle active"></div>
						</div>
						<div class="flag-desc">Show risk analysis in listings</div>
					</div>

					<div class="flag-item" data-flag="early_advisor_intro">
						<div class="flag-header">
							<span class="flag-name">early_advisor_intro</span>
							<div class="flag-toggle"></div>
						</div>
						<div class="flag-desc">Offer advisor in Concierge</div>
					</div>
				</div>

				<div class="flag-group">
					<h3>Agent Routing</h3>

					<div class="flag-item active" data-flag="auto_handoff_after_details">
						<div class="flag-header">
							<span class="flag-name">auto_handoff_after_details</span>
							<div class="flag-toggle active"></div>
						</div>
						<div class="flag-desc">Auto-transfer after listing details</div>
					</div>
				</div>
			</aside>

			<main class="chat-panel">
				<div class="chat-header">
					<div class="user-id">User ID: <span id="userId"></span></div>
					<button class="new-user-btn" onclick="newConversation()">
						New Conversation
					</button>
				</div>

				<div class="messages" id="messages">
					<!-- Messages will be added here -->
				</div>

				<div class="input-area">
					<input
						type="text"
						id="messageInput"
						placeholder="Type your message... (e.g., 'Show me entertainment businesses')"
						onkeypress="if(event.key === 'Enter') sendMessage()"
					/>
					<button onclick="sendMessage()" id="sendBtn">Send</button>
				</div>
			</main>
		</div>

		<script>
			// State
			let userId = generateUserId();
			let threadId = null;
			let flags = {
				aggressive_capture: false,
				require_both_contacts: false,
				show_risks_upfront: true,
				early_advisor_intro: false,
				auto_handoff_after_details: true,
			};

			// Initialize
			document.getElementById('userId').textContent = userId;
			checkConnection();

			// Feature flag toggles
			document.querySelectorAll('.flag-toggle').forEach((toggle) => {
				toggle.addEventListener('click', function () {
					const flagItem = this.closest('.flag-item');
					const flagName = flagItem.dataset.flag;

					const isActive = flagItem.classList.contains('active');
					if (isActive) {
						flagItem.classList.remove('active');
						this.classList.remove('active');
						flags[flagName] = false;
					} else {
						flagItem.classList.add('active');
						this.classList.add('active');
						flags[flagName] = true;
					}

					console.log('Flag updated:', flagName, flags[flagName]);
				});
			});

			function generateUserId() {
				return 'user_' + Math.random().toString(36).substr(2, 9);
			}

			async function checkConnection() {
				const apiUrl = document.getElementById('apiUrl').value;
				const statusDot = document.getElementById('statusDot');
				const statusText = document.getElementById('statusText');

				try {
					// Try to connect to LangGraph - use /ok endpoint
					const response = await fetch(`${apiUrl}/ok`, { method: 'GET' });
					if (response.ok) {
						statusDot.classList.add('connected');
						statusText.textContent = 'Connected to LangGraph';
						return true;
					} else {
						throw new Error('Health check failed');
					}
				} catch (error) {
					statusDot.classList.remove('connected');
					statusText.textContent =
						'LangGraph not running - Start with: langgraph dev';
					console.error('Connection error:', error);
					return false;
				}
			}

			async function newConversation() {
				userId = generateUserId();
				threadId = null;
				document.getElementById('userId').textContent = userId;

				const messages = document.getElementById('messages');
				messages.innerHTML = '';

				// Check connection and start if available
				const connected = await checkConnection();
				if (connected) {
					addMessage(
						'agent',
						'Welcome to Baton! I can help you explore businesses for sale. What kind of business are you interested in?',
						'Concierge'
					);
				} else {
					addMessage(
						'system',
						'‚ö†Ô∏è LangGraph is not running. Start it with: langgraph dev',
						'System'
					);
				}
			}

			async function sendMessage() {
				const input = document.getElementById('messageInput');
				const message = input.value.trim();
				if (!message) return;

				const sendBtn = document.getElementById('sendBtn');
				sendBtn.disabled = true;

				// Add user message
				addMessage('user', message);
				input.value = '';

				// Show thinking
				const thinkingId = addThinking();

				try {
					const apiUrl = document.getElementById('apiUrl').value;

					// Prepare request body
					const requestBody = {
						messages: [{ role: 'user', content: message }],
						user_id: userId,
						...flags, // Pass flags to backend
					};

					// If we have a thread, include it
					if (threadId) {
						requestBody.thread_id = threadId;
					}

					// Call LangGraph API
					const response = await fetch(`${apiUrl}/runs/stream`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							assistant_id: 'agent',
							input: requestBody,
							stream_mode: 'values',
						}),
					});

					if (!response.ok) {
						throw new Error(`API error: ${response.status}`);
					}

					// Handle streaming response
					const reader = response.body.getReader();
					const decoder = new TextDecoder();
					let agentResponse = '';
					let currentAgent = 'Agent';

					while (true) {
						const { done, value } = await reader.read();
						if (done) break;

						const chunk = decoder.decode(value);
						const lines = chunk.split('\n');

						for (const line of lines) {
							if (line.startsWith('data: ')) {
								try {
									const data = JSON.parse(line.substring(6));

									// Extract assistant message
									if (data.messages && data.messages.length > 0) {
										const lastMsg = data.messages[data.messages.length - 1];
										if (lastMsg.type === 'ai' || lastMsg.role === 'assistant') {
											agentResponse = lastMsg.content;
										}
									}

									// Save thread ID
									if (data.thread_id) {
										threadId = data.thread_id;
									}
								} catch (e) {
									// Skip malformed JSON
								}
							}
						}
					}

					removeThinking(thinkingId);

					if (agentResponse) {
						addMessage('agent', agentResponse, currentAgent);
					} else {
						addMessage(
							'agent',
							'I received your message but had trouble processing it. Could you try again?',
							'Agent'
						);
					}
				} catch (error) {
					removeThinking(thinkingId);
					console.error('Error:', error);
					addMessage(
						'system',
						`Error: ${error.message}. Make sure LangGraph is running (langgraph dev)`,
						'System'
					);
				} finally {
					sendBtn.disabled = false;
				}
			}

			function addMessage(role, text, agentName = null) {
				const messages = document.getElementById('messages');
				const isUser = role === 'user';
				const isSystem = role === 'system';

				const activeFlags = Object.entries(flags)
					.filter(([k, v]) => v)
					.map(([k]) => k);

				const flagBadges =
					activeFlags.length > 0 && !isUser && !isSystem
						? activeFlags
								.map((f) => `<span class="flag-badge">üö© ${f}</span>`)
								.join('')
						: '';

				const avatar = isUser ? 'üë§' : isSystem ? '‚öôÔ∏è' : 'ü§ñ';
				const roleText = isUser
					? 'You'
					: isSystem
					? 'System'
					: agentName || 'Agent';

				const messageHTML = `
                <div class="message ${role}">
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-meta">
                            <span class="message-role">${roleText}</span>
                            ${
															!isUser && !isSystem
																? `<span class="agent-name">${flagBadges}</span>`
																: ''
														}
                        </div>
                        <div class="message-text">${text}</div>
                    </div>
                </div>
            `;

				messages.insertAdjacentHTML('beforeend', messageHTML);
				messages.scrollTop = messages.scrollHeight;
			}

			function addThinking() {
				const messages = document.getElementById('messages');
				const thinkingId = 'thinking-' + Date.now();

				const thinkingHTML = `
                <div class="message agent" id="${thinkingId}">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="thinking">
                            <span>Thinking</span>
                            <div class="loading"></div>
                            <div class="loading"></div>
                            <div class="loading"></div>
                        </div>
                    </div>
                </div>
            `;

				messages.insertAdjacentHTML('beforeend', thinkingHTML);
				messages.scrollTop = messages.scrollHeight;

				return thinkingId;
			}

			function removeThinking(thinkingId) {
				const thinking = document.getElementById(thinkingId);
				if (thinking) thinking.remove();
			}

			// Initialize conversation
			newConversation();
		</script>
	</body>
</html>
